app.controller('Profil',function($scope,$mdConstant,ProfileService,CommonService,$interval){console.log("Profil Controller reporting for duty.");$scope.VOLUNTEER_MILESTONES=[{ID:1,NAME:"Aday Ahbap Süreciniz Başladı",STATUS:true,SUB_TASKS:[{ID:1,NAME:'Başvurunuz Onaylandı',STATUS:true,},{ID:2,NAME:'Aday Ahbap Grubuna Alındınız',STATUS:false,},]},{ID:2,NAME:"Etkinlikler",STATUS:false,SUB_TASKS:[{ID:1,NAME:'İlk Toplantı',STATUS:false,},{ID:2,NAME:'İlk Etlinlik',STATUS:false,},{ID:3,NAME:'İkinci Etlinlik',STATUS:false,},{ID:4,NAME:'Üçüncü Etlinlik',STATUS:false,},{ID:5,NAME:'Teorik Bilgi',STATUS:false,},]},{ID:3,NAME:"Merhaba Ahbap!",STATUS:false,SUB_TASKS:false},];$scope.EDUCATIONAL_STATUSES=[{ID:"1",NAME:"Okur-Yazar"},{ID:"2",NAME:"İlkokul"},{ID:"3",NAME:"Ortaokul"},{ID:"4",NAME:"Lise"},{ID:"5",NAME:"Ön Lisans"},{ID:"6",NAME:"Lisans"},{ID:"7",NAME:"Yüksek Lisans"},{ID:"8",NAME:"Doktora"}];$scope.BLOOD_GROUPS=[{ID:"1",NAME:"A Rh (+)"},{ID:"2",NAME:"A Rh (-)"},{ID:"3",NAME:"B Rh (+)"},{ID:"4",NAME:"B Rh (-)"},{ID:"5",NAME:"AB Rh (+)"},{ID:"6",NAME:"AB Rh (-)"},{ID:"7",NAME:"0 Rh (+)"},{ID:"8",NAME:"0 Rh (-)"}];$scope.SCHOOL_GRADES=[{ID:"0",NAME:"Hazırlık"},{ID:"1",NAME:"1"},{ID:"2",NAME:"2"},{ID:"3",NAME:"3"},{ID:"4",NAME:"4"},{ID:"5",NAME:"5"},{ID:"6",NAME:"6"}];$scope.USER_EXPERIENCES=[{ID:"0",NAME:"0-1 Yıl"},{ID:"1",NAME:"1-3 Yıl"},{ID:"2",NAME:"3-5 Yıl"},{ID:"3",NAME:"5-7 Yıl"},{ID:"4",NAME:"7-9 Yıl"},{ID:"5",NAME:"10 Yıl ve Üzeri"}];$scope.keys=[$mdConstant.KEY_CODE.ENTER,$mdConstant.KEY_CODE.COMMA];var semicolon=186;$scope.customKeys=[$mdConstant.KEY_CODE.ENTER,$mdConstant.KEY_CODE.COMMA,semicolon];ProfileService.checkForActiveCampaigns().then(function(response){$scope.HasActiveCampaign=response.data;});$scope.Profili_Duzenle=function(){if($scope.profil_duzenleme!==true){$scope.profil_duzenleme=true;}else{$scope.profil_duzenleme=false;}};$scope.Profili_Sil=function(){if($scope.profil_silme!==true){$scope.profil_silme=true;}else{$scope.profil_silme=false;}};$scope.DELETE_ACCOUNT=function(){ProfileService.deleteAccount().then(function(response){if(response.data.data.status){window.location.href=BASE_URL;}
else{if(response.data.data.redirectUrl==""){Swal.fire({title:"Hata!",html:response.data.message,icon:"error",showConfirmButton:true,confirmButtonText:"TAMAM"});}
else{Swal.fire({title:"Hata!",html:response.data.message,icon:"error",showConfirmButton:true,confirmButtonText:"Ayarlar'a Git",showCancelButton:true,cancelButtonText:"İPTAL"}).then(function(result){if(result.value){window.location.href=response.data.data.redirectUrl;}});}}});};$scope.SifreDegistir=function(){if($scope.sifre_degistirme!==true){$scope.sifre_degistirme=true;}else{$scope.sifre_degistirme=false;}};$scope.meslekAra=function(arananMeslek){return ProfileService.getJobs(arananMeslek).then(function(response){return response.data.Data;});};$scope.PROFILE_UPDATED=false;$scope.UPDATE_USER_ADDITIONAL_DATA=function(){ProfileService.updateUserData($scope.USER_DATA).then(function(response){if(response.data.data){console.log(response);$scope.UPDATE_USER_DATA_SUCCESS=true;isPhoneVerificationTimeout=true;$scope.Profili_Duzenle();}else{console.log(response);$("#update_user_data_err_msg").html(response.data.message);$scope.UPDATE_USER_DATA_ERR=true;}});};$scope.NEW={PASSWORD:"",PASSCONF:""};$scope.RESET_PASSWORD=function(){$scope.PASSWORD_CHANGED=false;$scope.PASSWORD_NOT_CHANGED=false;ProfileService.resetPassword($scope.NEW.PASSWORD,$scope.NEW.PASSCONF).then(function(response){if(response.data){$scope.PASSWORD_CHANGED=true;$scope.PASSWORD_NOT_CHANGED=false;$scope.NEW.PASSWORD="";$scope.NEW.PASSCONF="";}
if(!response.data){$scope.PASSWORD_CHANGED=false;$scope.PASSWORD_NOT_CHANGED=true;}});};$scope.changeWorkGroup=function(workGroupId){if($scope.USER_DATA.VolunteerWorkGroups==null){$scope.USER_DATA.VolunteerWorkGroups=[];}
var index=$scope.USER_DATA.VolunteerWorkGroups.indexOf(workGroupId);if(index>-1){$scope.USER_DATA.VolunteerWorkGroups.splice(index,1);}else{$scope.USER_DATA.VolunteerWorkGroups.push(workGroupId);}};$scope.changeHearAboutUs=function(optionId){var index=$scope.USER_DATA.UserHearAboutUs.indexOf(optionId);if(index>-1){$scope.USER_DATA.UserHearAboutUs.splice(index,1);}else{$scope.USER_DATA.UserHearAboutUs.push(optionId);}};$scope.sendMailVerification=function(){$("#sendMailBtn").attr("disabled","disabled");$("#sendMailBtn").html("gönderiliyor...");ProfileService.sendVerificationMail().then(function(response){if(response.data){$scope.MAIL_VERIFICATION_STATUS=true;}else{$scope.MAIL_VERIFICATION_STATUS=false;}
$("#sendMailBtn").html("gönder.");$("#sendMailBtn").removeAttr("disabled");}).catch(function(){$("#sendMailBtn").html("gönder.");$("#sendMailBtn").removeAttr("disabled");$scope.MAIL_VERIFICATION_STATUS=false;});};$scope.sendSMSVerification=function(){$("#sendButton").html("Onayla");$scope.SMS_VERCODE="";if($('#reSendButton').is(':visible')){$('#reSendButton').fadeToggle();}
ProfileService.sendVerificationSMS().then(function(response){if(response.data.status=="success"){$("#sendButton").removeAttr("disabled");if($('#wrapper').is(':hidden')){$('#wrapper').fadeToggle();$('.overlay').fadeToggle();$("#SMS_VERCODE").focus();}
$scope.SMS_OTP_VALIDDATE=new Date(response.data.validDate);console.log($scope.SMS_OTP_VALIDDATE);$scope.SMS_PHONE_NUMBER=response.data.phoneNumber;$scope.SMS_REF_CODE=response.data.referenceCode;var deadline=new Date(Date.parse($scope.SMS_OTP_VALIDDATE)+2*12*60*60*1000);$scope.CountDown.initializeClock(deadline);showMessage("success","Onay kodu telefonunuza gönderildi!");}else{$scope.ERROR_MESSAGE=true;}}).catch(function(){$scope.ERROR_MESSAGE=true;});if($('#wrapper').is(':hidden')){$('#wrapper').fadeToggle();$('.overlay').fadeToggle();$("#SMS_VERCODE").focus();}};$scope.sendSMSVerificationCode=function(){$("#sendButton").attr("disabled","disabled");$("#sendButton").html("gönderiliyor...");var verificationCode=$("#SMS_VERCODE").val();if(verificationCode==null||verificationCode==""||verificationCode.length<4){showMessage("fail","4 haneli SMS onay kodunu girmeniz gerekmektedir!");$("#sendButton").html("Onayla");$("#sendButton").removeAttr("disabled");return;}
ProfileService.sendVerificationSMSCode(verificationCode).then(function(response){if(response.data){$('#wrapper').fadeToggle();$('.overlay').fadeToggle();$scope.SMS_VERIFICATION_STATUS=true;stopTimer();$("#sendButton").removeAttr("disabled");$('#smsVerificationAlert').fadeToggle();}else{showMessage("fail","Girilen kod yanlış!");$scope.SMS_VERCODE="";$("#sendButton").html("Onayla");$("#sendButton").removeAttr("disabled");}
$("#sendButton").html("Onayla");}).catch(function(){$('#wrapper').fadeToggle();$('.overlay').fadeToggle();$scope.ERROR_MESSAGE=tr;});};$scope.CountDown={days:0,hours:0,minutes:0,seconds:0,getTimeRemaining:function(endtime){var t=Date.parse(endtime)-Date.parse(new Date());var seconds=Math.floor((t/1000)%60);var minutes=Math.floor((t/1000/60)%60);var hours=Math.floor((t/(1000*60*60))%24);var days=Math.floor(t/(1000*60*60*24));return{'total':t,'days':days,'hours':hours,'minutes':minutes,'seconds':seconds};},initializeClock:function(endtime){function updateClock(){var t=$scope.CountDown.getTimeRemaining(endtime);$scope.CountDown.days=t.days<10?'0'+t.days:t.days;$scope.CountDown.hours=('0'+t.hours).slice(-2);$scope.CountDown.minutes=('0'+t.minutes).slice(-2);$scope.CountDown.seconds=('0'+t.seconds).slice(-2);if(t.total<=0){$interval.cancel(timeinterval);}}
updateClock();var timeinterval=$interval(updateClock,1000);}}
$scope.SELECT_AVATAR=function(){$("#ATTACHMENT").click();};$scope.FILE_IS_UPLOADING=false;$scope.UPLOAD_USER_AVATAR=function(){$scope.FILE_IS_UPLOADING=true;var file=dataURItoBlob($("#image_data").val());$("#crop_avatar").modal("toggle");ProfileService.UploadProfilePhoto(file).then(function(response){if(response.data.data!=null&&response.data.data!=""){$scope.USER_DATA.ProfilePhoto=response.data.data;$scope.FILE_IS_UPLOADING=false;$("#ATTACHMENT").val('');var path=$scope.S3_URL+"avatars/"+$scope.USER_DATA.Id+"/"+response.data.data;$("#profile_photo").removeAttr("src").removeAttr("ng-src").attr("src",path).attr("ng-src",path);}});};function dataURItoBlob(dataURI){var byteString;if(dataURI.split(',')[0].indexOf('base64')>=0)
byteString=atob(dataURI.split(',')[1]);else
byteString=unescape(dataURI.split(',')[1]);var mimeString=dataURI.split(',')[0].split(':')[1].split(';')[0];var ia=new Uint8Array(byteString.length);for(var i=0;i<byteString.length;i++){ia[i]=byteString.charCodeAt(i);}
return new Blob([ia],{type:mimeString});}
$scope.initPage=async function(){await CommonService.listHearAboutUs().then(function(response){$scope.hearAboutUsOptions=response.data;});await CommonService.listCountries().then(function(response){$scope.ulkeler=response.data.data;});await CommonService.listCities().then(function(response){$scope.sehirler=response.data.data;});}
$scope.initPage();$scope.getTownsByCity=async function(cityId){if(cityId!=undefined&&cityId!=null){await CommonService.listTownsByCity(cityId).then(function(response){$scope.ilceler=response.data.data;});}};$scope.removeTowns=async function(){$scope.ilceler=null;};$scope.CandidateApplicationStatus=null;ProfileService.checkCandidateApplication().then(function(response){$scope.CandidateApplicationStatus=response.data.data;});});